#!/usr/local/bin/perl
######################################################################## 
# rem_dep myfile.o depend_file     - remove myfile.o entry from depend_file
#
# Created Aug. 10, 1998 - Lynn Garren
#
######################################################################## 
# describe command syntax if no arguments are given
if ( $ARGV[1] eq "" ) {
    print("rem_dep myfile.o depend_file\n");
    print(" \n");
    print("  - remove myfile.o entry from depend_file\n");
    print(" \n");
    die "rem_dep: specify file names\n";
}

#-------- trap signals
$SIG{'INT'} = 'handler';
$SIG{'QUIT'} = 'handler';
# read command line arguments
$depfile = $ARGV[0];
$dependfile = $ARGV[1];
$^I = ".bak";
# extract base file name
@words=split(/\//,$depfile);
$fileo = pop( @words );
$fileg = $fileo;
$fileg =~ s/\.o/_g\.o/;
##print "fixing  $fileo in $dependfile\n";

# create $dependfile if it doesn't exist
if( -e $dependfile ) {
    &check_old_file;
} else {
    die "rem_dep: $dependfile does not exist\n"
}
#-------- restore signals
$SIG{'INT'} = 'DEFAULT';
$SIG{'QUIT'} = 'DEFAULT';
#---------

sub check_old_file {
    $foundit = 0;
    open( OLD, "<$dependfile" ) || die "rem_dep: cannot open $dependfile\n";
    rename( $dependfile, "$dependfile$^I" );
    open( NEW, ">$dependfile");
    while($line = <OLD> ) {
	if( index($line,$fileo) >= 0 ) {		# found entry for myfile.o
            $foundit = 1;
	} elsif( index($line,$fileg) >= 0 ) {	# found entry for myfile_g.o
            $foundit = 1;
	} elsif( index($line," ") != 0 ) {		# not a continuation line
            $foundit = 0;
	    print NEW "$line";
	} else {
            if( $foundit == 0 ) {
		print NEW "$line";
	    }
	}
    }
    close OLD;
    close NEW;
}

sub handler { # signal handler
    local($sig) = @_;   # first argument is signal name
    print "Found SIG$sig - exit gracefully\n";
    $h1 = fileno(OLD);		# filehandle
    $h2 = fileno(NEW);
    if( $h1 =~ /\w/ && $h2 =~ /\w/ ) { 
        #print "OLD and NEW are open\n"; 
        close( OLD );
        close( NEW );
        print "renaming $dependfile$^I to $dependfile \n";
        print "any changes to $dependfile have been lost\n";
        rename("$dependfile$^I", $dependfile );
    } elsif( $h2 =~ /\w/ ) { 
        close( NEW );
	print "rem_dep: $dependfile is probably corrupt\n";
    }
    exit(0);
}
